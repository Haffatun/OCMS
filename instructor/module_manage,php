<?php
session_start();
require_once '../db.php';

// Check login and instructor role
if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'instructor') {
    header("Location: ../login.php");
    exit;
}

$user_id = $_SESSION['user_id'];

// Get course_id from query string
$course_id = filter_input(INPUT_GET, 'course_id', FILTER_VALIDATE_INT);
if (!$course_id) {
    die("Invalid course ID.");
}

// Verify the course belongs to this instructor
$stmtCourse = $pdo->prepare("SELECT * FROM courses WHERE course_id = ? AND instructor_id = ?");
$stmtCourse->execute([$course_id, $user_id]);
$course = $stmtCourse->fetch();

if (!$course) {
    die("Course not found or you don't have permission to manage it.");
}

// Handle add module form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Adding a new module
    if (isset($_POST['add_module'])) {
        $title = trim($_POST['title']);
        $description = trim($_POST['description']);
        $order_index = intval($_POST['order_index']);

        if ($title === '' || $order_index <= 0) {
            $error = "Please provide a valid module title and order.";
        } else {
            $stmtInsert = $pdo->prepare("INSERT INTO modules (course_id, title, description, order_index, status) VALUES (?, ?, ?, ?, 'draft')");
            $stmtInsert->execute([$course_id, $title, $description, $order_index]);
            $success = "Module added successfully!";
        }
    }

    // Adding material to a module
    if (isset($_POST['add_material'])) {
        $module_id = intval($_POST['module_id']);
        $mat_title = trim($_POST['material_title']);
        $mat_type = $_POST['material_type'];
        $mat_url = trim($_POST['material_url']);

        // Basic validation
        if ($mat_title === '' || $mat_url === '') {
            $error = "Please provide material title and URL.";
        } else {
            // Verify module belongs to this course and instructor
            $stmtCheck = $pdo->prepare("SELECT m.module_id FROM modules m JOIN courses c ON m.course_id = c.course_id WHERE m.module_id = ? AND c.instructor_id = ?");
            $stmtCheck->execute([$module_id, $user_id]);
            if ($stmtCheck->fetch()) {
                $stmtMatInsert = $pdo->prepare("INSERT INTO materials (module_id, title, type, url) VALUES (?, ?, ?, ?)");
                $stmtMatInsert->execute([$module_id, $mat_title, $mat_type, $mat_url]);
                $success = "Material added successfully!";
            } else {
                $error = "Invalid module or permission denied.";
            }
        }
    }
}

// Fetch all modules with their materials for this course ordered by order_index
$stmtModules = $pdo->prepare("SELECT * FROM modules WHERE course_id = ? ORDER BY order_index ASC");
$stmtModules->execute([$course_id]);
$modules = $stmtModules->fetchAll();

function esc($str)
{
    return htmlspecialchars($str, ENT_QUOTES, 'UTF-8');
}
?>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Manage Modules & Materials - <?php echo esc($course['title']); ?></title>
    <link rel="stylesheet" href="../style.css" />
    <style>
        .module-list {
            margin-top: 20px;
        }

        .module-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
            box-shadow: 0 2px 5px rgb(0 0 0 / 0.05);
        }

        .module-title {
            font-weight: 700;
            font-size: 1.25rem;
            color: #2563eb;
            margin-bottom: 6px;
        }

        .module-description {
            font-size: 1rem;
            color: #475569;
            margin-bottom: 8px;
            white-space: pre-wrap;
        }

        .module-order {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .materials-list {
            margin-top: 12px;
            padding-left: 20px;
            margin-bottom: 15px;
        }

        .materials-list li {
            margin-bottom: 6px;
            font-size: 0.95rem;
        }

        .material-type {
            font-weight: 600;
            color: #2563eb;
            margin-right: 6px;
        }

        form.add-material {
            background: #f9fafb;
            padding: 15px 20px;
            border-radius: 8px;
            max-width: 600px;
            margin-top: 15px;
        }

        form.add-material label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            margin-top: 10px;
        }

        form.add-material input[type="text"],
        form.add-material select {
            width: 100%;
            padding: 7px 10px;
            font-size: 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
        }

        form.add-material button {
            margin-top: 12px;
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 9px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        form.add-material button:hover {
            background-color: #1e40af;
        }

        .message {
            margin-top: 10px;
            font-weight: 600;
        }

        .error {
            color: #dc2626;
        }

        .success {
            color: #16a34a;
        }

        a.back-link {
            display: inline-block;
            margin-top: 20px;
            color: #2563eb;
            font-weight: 600;
            text-decoration: none;
        }

        a.back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <header>
        <div class="container">
            <h1><span class="logo">DG</span> <span class="brand">DevGeeks Instructor</span></h1>
            <nav>
                <ul>
                    <li><a href="../index.php">Home</a></li>
                    <li><a href="mycourses.php">My Courses</a></li>
                    <li><a href="notices.php">Notices</a></li>
                    <li><a href="notification_view.php">Notifications</a></li>
                    <li><a href="../logout.php">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container" style="margin-top: 100px;">
        <h2>Manage Modules & Materials for: <?php echo esc($course['title']); ?></h2>

        <?php if (isset($error)): ?>
            <p class="message error"><?php echo esc($error); ?></p>
        <?php elseif (isset($success)): ?>
            <p class="message success"><?php echo esc($success); ?></p>
        <?php endif; ?>

        <div class="module-list">
            <?php if (empty($modules)): ?>
                <p>No modules added yet.</p>
            <?php else: ?>
                <?php foreach ($modules as $module): ?>
                    <div class="module-card">
                        <div class="module-title"><?php echo esc($module['title']); ?></div>
                        <div class="module-order">Order: <?php echo esc($module['order_index']); ?></div>
                        <div class="module-description"><?php echo nl2br(esc($module['description'])); ?></div>

                        <?php
                        // Fetch materials for this module
                        $stmtMat = $pdo->prepare("SELECT * FROM materials WHERE module_id = ? ORDER BY material_id ASC");
                        $stmtMat->execute([$module['module_id']]);
                        $materials = $stmtMat->fetchAll();
                        ?>

                        <h4>Materials</h4>
                        <?php if (empty($materials)): ?>
                            <p>No materials added yet.</p>
                        <?php else: ?>
                            <ul class="materials-list">
                                <?php foreach ($materials as $mat): ?>
                                    <li>
                                        <span class="material-type"><?php echo esc(ucfirst($mat['type'])); ?>:</span>
                                        <a href="<?php echo esc($mat['url']); ?>" target="_blank" rel="noopener noreferrer">
                                            <?php echo esc($mat['title']); ?>
                                        </a>
                                    </li>
                                <?php endforeach; ?>
                            </ul>
                        <?php endif; ?>

                        <form class="add-material" method="POST" action="">
                            <h5>Add New Material</h5>
                            <input type="hidden" name="module_id" value="<?php echo esc($module['module_id']); ?>" />

                            <label for="material_title_<?php echo esc($module['module_id']); ?>">Title</label>
                            <input type="text" id="material_title_<?php echo esc($module['module_id']); ?>"
                                name="material_title" required />

                            <label for="material_type_<?php echo esc($module['module_id']); ?>">Type</label>
                            <select id="material_type_<?php echo esc($module['module_id']); ?>" name="material_type" required>
                                <option value="">Select type</option>
                                <option value="video">Video</option>
                                <option value="document">Document</option>
                                <option value="link">Link</option>
                                <option value="audio">Audio</option>
                                <option value="other">Other</option>
                            </select>

                            <label for="material_url_<?php echo esc($module['module_id']); ?>">URL</label>
                            <input type="text" id="material_url_<?php echo esc($module['module_id']); ?>" name="material_url"
                                required />

                            <button type="submit" name="add_material">Add Material</button>
                        </form>
                    </div>
                <?php endforeach; ?>
            <?php endif; ?>
        </div>

        <a href="mycourses.php" class="back-link">← Back to My Courses</a>
    </main>
</body>

</html>
